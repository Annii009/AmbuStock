services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: ambustock-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=P@ssw0rd2025!
      - MSSQL_PID=Developer
    ports:
      - "8308:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./SqlServer:/sql-scripts:ro
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'P@ssw0rd2025!' -C -Q 'SELECT 1' || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - ambustock-network

  init-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: ambustock-init-db
    volumes:
      - ./SqlServer:/sql-scripts:ro
    user: root
    entrypoint: /bin/bash
    command: >
      -c "
        until /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P 'P@ssw0rd2025!' -C -Q 'SELECT 1' &>/dev/null; do
          sleep 2;
        done;
        /opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P 'P@ssw0rd2025!' -C -i /sql-scripts/init-db.sql;
      "
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - ambustock-network

  backend:
    build:
      context: .
      dockerfile: AmbustockBackend/Dockerfile
    container_name: ambustock-backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__CadenaConexionAmbustock=Server=sqlserver,1433;Database=AmbustockDB;User Id=sa;Password=P@ssw0rd2025!;TrustServerCertificate=True;Encrypt=False
    ports:
      - "5002:8080"
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks:
      - ambustock-network
    restart: on-failure

  frontend:
    build:
      context: .
      dockerfile: AmbustockFrontend/Dockerfile
    container_name: ambustock-frontend
    ports:
      - "5501:5501"
    depends_on:
      - backend
    networks:
      - ambustock-network
    restart: on-failure

  nginx:
    image: nginx:alpine
    container_name: ambustock-nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - ambustock-network

volumes:
  sqlserver_data:

networks:
  ambustock-network:
    driver: bridge