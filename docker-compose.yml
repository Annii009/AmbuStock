version: '3.8'

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: ambustock-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=P@ssw0rd2025!
      - MSSQL_PID=Developer
    ports:
      - "8308:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./SqlServer:/sql-scripts
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'P@ssw0rd2025!' -C -Q 'SELECT 1' || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - ambustock-network

  backend:
    build:
      context: .
      dockerfile: AmbustockBackend/Dockerfile
    container_name: ambustock-backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__CadenaConexionAmbustock=Server=sqlserver,1433;Database=AmbustockDB;User Id=sa;Password=P@ssw0rd2025!;TrustServerCertificate=True;Encrypt=False
      - JwtSettings__SecretKey=ambustock-super-secret-key-2026-debe-tener-minimo-32-caracteres-para-seguridad
      - JwtSettings__Issuer=AmbustockBackend
      - JwtSettings__Audience=AmbustockFrontend
    ports:
      - "5002:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - ambustock-network
    restart: on-failure

  frontend:
    build:
      context: .
      dockerfile: AmbustockFrontend/Dockerfile
    container_name: ambustock-frontend
    ports:
      - "5501:5501"
    depends_on:
      - backend
    networks:
      - ambustock-network
    restart: on-failure

  nginx:
    image: nginx:alpine
    container_name: ambustock-nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ambustock-network

volumes:
  sqlserver_data:
    driver: local

networks:
  ambustock-network:
    driver: bridge
